---
import { condenser_api_get_content, getPostComments } from 'hiveblogkit';
import { marked } from 'marked';
import Layout from '../../../../layouts/Layout.astro'; // Import Layout
import CommentCard from '/src/components/CommentCard.astro';

export async function getStaticPaths() {
  return [];
}

const { communityId, author, permlink } = Astro.params;

let post = null;
let errorMessage = null;

let processedBody = '';
let comments = [];

function replaceImageUrlsWithImgTags(htmlContent) {
  if (!htmlContent) return '';
  const imageUrlRegex = /(?<!src=")(?<!href=")(?<!src= ")(?<!href= ")(https?:[^\s]+\.(?:jpg|jpeg|png|gif|webp|svg))/gi;
  return htmlContent.replace(imageUrlRegex, (url) => `<img src="${url}" alt="Imagen cargada desde la URL">`);
}

try {
  const response = await condenser_api_get_content(author, permlink);
  if (response && response.result) {
    post = response.result;

    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    const postDate = new Date(post.created);

    if (postDate < sevenDaysAgo) {
      errorMessage = "Este post es demasiado antiguo para ser mostrado.";
      post = null; 
    } else {
      // Process Markdown to HTML
      let tempBody = marked(post.body);
      processedBody = replaceImageUrlsWithImgTags(tempBody);

      // Fetch comments for the post
      comments = await getPostComments(author, permlink);
      if (!comments) {
        console.warn(`No comments found for ${author}/${permlink} or an error occurred.`);
        comments = []; // Ensure comments is an empty array if null
      }
    }

  } else {
    errorMessage = "Post no encontrado o error al cargar.";
  }
} catch (error) {
  console.error(`Error fetching post ${permlink} from community ${communityId}:`, error);
  errorMessage = "Error al cargar el post.";
}

function sanitizeHtml(html) {
  if (!html) return '';
  return html.replace(/<script\b[^<]*(?:(?!<\/script>)[^<]*)*<\/script>/gi, '')
             .replace(/on\w+=["'][^"']*["']/gi, '');
}

const sanitizedBody = post ? sanitizeHtml(processedBody) : '';
---

<Layout title={post ? post.title : 'Post no encontrado'} description={post ? post.description : ''}>
  <article class="post-detail-container">
    {post && post.image && <img src={post.image} alt={post.title} class="post-detail-image" />}
    <h1 class="post-detail-title">{post ? post.title : ''}</h1>
    <div class="post-detail-meta">
      <span>Por <a href="#">@{post ? post.author : ''}</a></span>
      <span> el {post ? new Date(post.created).toLocaleDateString() : ''}</span>
    </div>
    <div class="post-content-body" set:html={sanitizedBody}></div>
  </article>

  {comments && comments.length > 0 && (
    <div class="post-detail-container">
      <section class="post-comments-section">
        <h2>Comentarios ({comments.length})</h2>
        <div class="comments-list">
          {comments.map((comment) => (
            <CommentCard comment={comment} isNested={false} />
          ))}
        </div>
      </section>
    </div>
  )}

  <p><a href={`/comunidades/${communityId}`}>Volver a la Comunidad</a></p>

<style>
  .post-comments-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .post-comments-section h2 {
    font-size: 1.8rem;
    margin-bottom: 1.5rem;
    color: var(--color-heading);
  }

  .comments-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
</style>